{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/usuarios.css">
<style>
    .monitoring-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }

    .timer-display {
        font-size: 2.5rem;
        font-weight: bold;
        color: #343497;
        margin: 10px 0;
    }

    .btn-control {
        margin-right: 10px;
        margin-bottom: 10px;
        min-width: 120px;
    }

    .activity-list {
        max-height: 400px;
        overflow-y: auto;
    }
</style>

<div class="usuarios-container">
    <div class="titulo-principal">
        <h1>Sesión de Monitoreo</h1>
        <div>
            <span class="badge bg-primary" style="font-size: 1rem;">Empleado: {{ user }}</span>
            <span class="badge bg-secondary" style="font-size: 1rem;">ID: {{ id_user }}</span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="monitoring-card text-center">
                <h3>Tiempo Transcurrido</h3>
                <div id="tiempo" class="timer-display">0 segundos</div>
                <div id="actividadActual" class="mt-2 text-muted">Ninguna actividad seleccionada</div>
            </div>

            <div class="monitoring-card">
                <h3>Controles</h3>
                <div class="d-flex flex-wrap justify-content-center">
                    <button class="btn btn-warning btn-control" onclick="pausar()">
                        <span class="material-symbols-outlined align-middle">pause</span> Pausar
                    </button>
                    <button class="btn btn-success btn-control" onclick="reanudar()">
                        <span class="material-symbols-outlined align-middle">play_arrow</span> Reanudar
                    </button>
                    <button class="btn btn-danger btn-control" onclick="finalizar()">
                        <span class="material-symbols-outlined align-middle">stop</span> Finalizar
                    </button>
                </div>
                <p id="estado" class="text-center mt-3 fw-bold text-primary"></p>
            </div>
        </div>

        <div class="col-md-8">
            <div class="monitoring-card">
                <h3>Seleccionar Actividad</h3>
                <p class="text-muted">Haga clic en una actividad para comenzar el monitoreo</p>
                <div class="tabla-responsive activity-list">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Actividad</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in activities %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ activity[1] }}</strong></td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm"
                                        onclick="cambiarActividad('{{ activity[0] }}', '{{ activity[1] }}')">
                                        Monitorear
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Configuración inicial
    const ID_USER = "{{ id_user or '' }}";
    const USER_NAME = "{{ user or '' }}";

    // Estado del monitoreo
    let actividadActualId = null;
    let actividadActualNombre = null;

    // Timer
    let segundos = 0;
    let intervalo = null;
    let enPausa = false;

    function pintarTiempo() {
        document.getElementById("tiempo").innerText = `${segundos} segundos`;
    }

    function iniciarConteo() {
        if (intervalo) return;
        intervalo = setInterval(() => {
            if (!enPausa) {
                segundos++;
                pintarTiempo();
            }
        }, 1000);
    }

    function detenerConteo() {
        clearInterval(intervalo);
        intervalo = null;
    }

    function resetConteo() {
        segundos = 0;
        pintarTiempo();
    }

    async function enviarPost(idActividad, nombreActividad, tiempoSegundos) {
        if (!ID_USER) {
            console.warn("Falta id_user en la URL.");
            return false;
        }

        const formData = new URLSearchParams();
        formData.append("id_user", ID_USER);
        formData.append("id_actividad", idActividad);
        formData.append("tiempo", String(tiempoSegundos));
        formData.append("user", USER_NAME);
        formData.append("nombre_actividad", nombreActividad);

        try {
            const res = await fetch("/movil_monitoring", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData.toString()
            });
            return res.ok;
        } catch (e) {
            console.error("Error en enviarPost:", e);
            return false;
        }
    }

    async function cambiarActividad(nuevaId, nuevaNombre) {
        try {
            if (actividadActualId !== null) {
                document.getElementById("estado").innerText =
                    `Guardando ${actividadActualNombre} (${segundos}s)...`;

                await enviarPost(actividadActualId, actividadActualNombre, segundos);
            }

            actividadActualId = nuevaId;
            actividadActualNombre = nuevaNombre;
            document.getElementById("actividadActual").innerText = `Actividad: ${actividadActualNombre}`;

            resetConteo();
            enPausa = false;
            iniciarConteo();

            document.getElementById("estado").innerText = `Monitoreando: ${actividadActualNombre}`;
        } catch (e) {
            console.error(e);
            document.getElementById("estado").innerText = "Error enviando el monitoreo.";
        }
    }

    function pausar() {
        if (actividadActualId === null) return;
        enPausa = true;
        document.getElementById("estado").innerText = "Pausado";
    }

    function reanudar() {
        if (actividadActualId === null) {
            alert("Selecciona una actividad primero.");
            return;
        }
        enPausa = false;
        iniciarConteo();
        document.getElementById("estado").innerText = "Reanudado";
    }

    async function finalizar() {
        if (!confirm("¿Desea finalizar el monitoreo y regresar al resumen?")) return;

        try {
            if (actividadActualId !== null) {
                document.getElementById("estado").innerText = "Finalizando y guardando...";
                await enviarPost(actividadActualId, actividadActualNombre, segundos);
            }

            detenerConteo();
            resetConteo();
            actividadActualId = null;
            actividadActualNombre = null;
            enPausa = false;

            document.getElementById("actividadActual").innerText = "Sesión finalizada";
            document.getElementById("estado").innerText = "Redirigiendo...";

            // Redirigir al inicio después de un breve delay para asegurar el POST
            setTimeout(() => {
                window.location.href = "/inicio";
            }, 500);

        } catch (e) {
            console.error(e);
            document.getElementById("estado").innerText = "Error al finalizar.";
            // Si hay error, igual redirigimos para no dejar al usuario atrapado
            window.location.href = "/inicio";
        }
    }
</script>
{% endblock %}