{% extends "base.html" %}
{% from "macros.html" import render_table %}

{% block content %}
<div class="monitoring-session-container">
    <div class="titulo-principal mb-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h1 class="h3 fw-bold d-flex align-items-center gap-2">
                <span class="material-symbols-outlined text-primary">timer</span>
                Sesión de Monitoreo
            </h1>
            <p class="text-muted mb-0">Seguimiento de actividades en tiempo real</p>
        </div>
        <div class="d-flex gap-2">
            <span class="badge bg-light text-primary border px-3 py-2 d-flex align-items-center gap-2">
                <span class="material-symbols-outlined small">person</span> {{ user }}
            </span>
            <span class="badge bg-light text-muted border px-3 py-2 d-flex align-items-center gap-2">
                <span class="material-symbols-outlined small">fingerprint</span> ID: {{ id_user }}
            </span>
        </div>
    </div>

    <div class="row g-4 mobile-stack">
        <!-- Panel de Control y Tiempo -->
        <div class="col-lg-5 col-xl-4">
            <div class="card-custom text-center p-4 mb-4 border-0 shadow-sm session-panel">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">Tiempo Transcurrido</h6>
                <div id="tiempo" class="display-2 fw-bold text-primary mb-2 ls-tight">0s</div>
                <div id="actividadActual" class="text-muted small py-2">
                    <span class="material-symbols-outlined align-middle small">info</span>
                    Selecciona una actividad para comenzar
                </div>
            </div>

            <div class="card-custom p-4 border-0 shadow-sm">
                <h6 class="text-uppercase text-muted small fw-bold mb-4">Controles de Sesión</h6>
                <div class="d-grid gap-3">
                    <div class="row g-2">
                        <div class="col-6">
                            <button
                                class="btn btn-warning w-100 d-flex flex-column align-items-center py-3 gap-2 shadow-sm border-0 text-white rounded-4"
                                onclick="pausar()">
                                <span class="material-symbols-outlined">pause_circle</span>
                                <span class="small fw-bold">Pausar</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button
                                class="btn btn-success w-100 d-flex flex-column align-items-center py-3 gap-2 shadow-sm border-0 rounded-4"
                                onclick="reanudar()">
                                <span class="material-symbols-outlined">play_circle</span>
                                <span class="small fw-bold">Reanudar</span>
                            </button>
                        </div>
                    </div>
                    <button
                        class="btn btn-danger w-100 py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm border-0 rounded-4"
                        onclick="finalizar()">
                        <span class="material-symbols-outlined">stop_circle</span>
                        <span class="fw-bold">Finalizar Sesión</span>
                    </button>
                </div>
                <div id="estado" class="mt-4 text-center small fw-medium text-primary p-2 bg-light rounded"
                    style="display: none;"></div>
            </div>
        </div>

        <!-- Selección de Actividades -->
        <div class="col-lg-7 col-xl-8">
            <div class="card-custom border-0 shadow-sm overflow-hidden p-0">
                <div class="card-header bg-white border-0 p-4">
                    <h6 class="text-uppercase text-muted small fw-bold mb-1">Catálogo de Actividades</h6>
                    <p class="text-muted small mb-0">Toca una actividad para iniciar el monitoreo</p>
                </div>

                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-hover align-middle mb-0 activity-table">
                        <thead class="bg-light">
                            <tr>
                                <th class="px-4 py-3 text-muted small" style="width: 60px;">#</th>
                                <th class="py-3 text-muted small">Nombre de la Actividad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in activities %}
                            <tr id="row-{{ activity[0] }}" class="clickable-row"
                                onclick="cambiarActividad('{{ activity[0] }}', '{{ activity[1] }}')">
                                <td class="px-4 text-muted small">{{ loop.index }}</td>
                                <td class="py-3">
                                    <div class="d-flex justify-content-between align-items-center pe-3">
                                        <div class="fw-semibold">{{ activity[1] }}</div>
                                        <span
                                            class="material-symbols-outlined text-muted small play-indicator">play_circle</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const ID_USER = "{{ id_user or '' }}";
    const USER_NAME = "{{ user or '' }}";

    let actividadActualId = null;
    let actividadActualNombre = null;
    let segundos = 0;
    let intervalo = null;
    let enPausa = false;

    function formatTime(s) {
        if (s < 60) return `${s}s`;
        const mins = Math.floor(s / 60);
        const secs = s % 60;
        return `${mins}m ${secs}s`;
    }

    function pintarTiempo() {
        document.getElementById("tiempo").innerText = formatTime(segundos);
    }

    function mostrarEstado(msg, persistent = false) {
        const el = document.getElementById("estado");
        el.innerText = msg;
        el.style.display = "block";
        if (!persistent) {
            setTimeout(() => { if (el.innerText === msg) el.style.display = "none"; }, 3000);
        }
    }

    function iniciarConteo() {
        if (intervalo) return;
        intervalo = setInterval(() => {
            if (!enPausa) {
                segundos++;
                pintarTiempo();
            }
        }, 1000);
    }

    function detenerConteo() {
        clearInterval(intervalo);
        intervalo = null;
    }

    function resetConteo() {
        segundos = 0;
        pintarTiempo();
    }

    async function enviarPost(idActividad, nombreActividad, tiempoSegundos) {
        if (!ID_USER) return false;

        const formData = new URLSearchParams();
        formData.append("id_user", ID_USER);
        formData.append("id_actividad", idActividad);
        formData.append("tiempo", String(tiempoSegundos));
        formData.append("user", USER_NAME);
        formData.append("nombre_actividad", nombreActividad);

        try {
            const res = await fetch("/movil_monitoring", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData.toString()
            });
            return res.ok;
        } catch (e) {
            console.error(e);
            return false;
        }
    }

    async function cambiarActividad(nuevaId, nuevaNombre) {
        try {
            if (actividadActualId !== null) {
                mostrarEstado(`Guardando ${actividadActualNombre}...`, true);
                await enviarPost(actividadActualId, actividadActualNombre, segundos);
            }

            // UI Feedback para la fila seleccionada
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('table-primary-subtle'));
            document.getElementById(`row-${nuevaId}`).classList.add('table-primary-subtle');

            actividadActualId = nuevaId;
            actividadActualNombre = nuevaNombre;
            document.getElementById("actividadActual").innerHTML = `
                <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                    Actividad Actual: ${actividadActualNombre}
                </span>`;

            resetConteo();
            enPausa = false;
            iniciarConteo();
            mostrarEstado(`Monitoreando: ${actividadActualNombre}`);
        } catch (e) {
            mostrarEstado("Error al cambiar actividad");
        }
    }

    function pausar() {
        if (actividadActualId === null) return;
        enPausa = true;
        mostrarEstado("Sesión Pausada");
    }

    function reanudar() {
        if (actividadActualId === null) {
            alert("Por favor, selecciona una actividad para comenzar.");
            return;
        }
        enPausa = false;
        iniciarConteo();
        mostrarEstado("Sesión Reanudada");
    }

    async function finalizar() {
        if (!confirm("¿Deseas finalizar la sesión de monitoreo? Los datos actuales se guardarán automáticamente.")) return;

        try {
            if (actividadActualId !== null) {
                mostrarEstado("Guardando y cerrando sesión...", true);
                await enviarPost(actividadActualId, actividadActualNombre, segundos);
            }

            detenerConteo();
            window.location.href = "/inicio";
        } catch (e) {
            window.location.href = "/inicio";
        }
    }
</script>

<style>
    .table-primary-subtle {
        background-color: rgba(74, 105, 189, 0.1) !important;
        border-left: 4px solid var(--primary);
    }
</style>
{% endblock %}