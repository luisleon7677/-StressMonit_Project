{% extends "base.html" %}
{% from "macros.html" import render_table, empty_state %}

{% block content %}
<div class="recursos-container">
  <div class="titulo-principal d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Gestión de Recursos</h1>
    <a href="/recursos/registrar" class="btn-primary-custom shadow-sm">
      <span class="material-symbols-outlined">library_add</span>
      Nuevo Recurso
    </a>
  </div>

  {% if resultados %}
  {% call render_table(["ID", "Título", "Autor", "Contenido", "Acciones"], table_id="tablaRecursos") %}
  {% for recurso in resultados %}
  <tr>
    <td><span class="badge bg-light text-dark">{{ recurso.id }}</span></td>
    <td class="fw-medium">{{ recurso.titulo }}</td>
    <td class="text-muted">{{ recurso.autor }}</td>
    <td>
      <div class="text-truncate" style="max-width: 400px;">{{ recurso.contenido }}</div>
    </td>
    <td class="text-center">
      <div class="dropdown">
        <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
          <span class="material-symbols-outlined">more_vert</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
          <li>
            <form action="{{ url_for('eliminar_recursos', id=recurso.id) }}" method="POST"
              onsubmit="return confirm('¿Eliminar este recurso?');">
              <button type="submit" class="dropdown-item text-danger d-flex align-items-center gap-2">
                <span class="material-symbols-outlined" style="font-size: 18px;">delete</span> Eliminar
              </button>
            </form>
          </li>
        </ul>
      </div>
    </td>
  </tr>
  {% endfor %}
  {% endcall %}
  {% else %}
  {{ empty_state("No se encontraron recursos") }}
  {% endif %}

</div>

<script>
  function ConfirmDelete() {
    return confirm("¿Estas seguro que deseas eliminar este recurso?");
  }

  const filasPorPagina = 5;
  let paginaActual = 1;

  function paginarTabla() {
    const cuerpo = document.getElementById('tablaBody');
    if (!cuerpo) return;
    const filas = Array.from(cuerpo.querySelectorAll('tr'));
    const totalPaginas = Math.ceil(filas.length / filasPorPagina);

    filas.forEach(fila => fila.style.display = 'none');
    const inicio = (paginaActual - 1) * filasPorPagina;
    const fin = inicio + filasPorPagina;
    filas.slice(inicio, fin).forEach(fila => fila.style.display = '');

    renderPaginacion(totalPaginas);
  }

  function renderPaginacion(total) {
    const paginacion = document.getElementById('paginacionTabla');
    if (!paginacion) return;
    paginacion.innerHTML = '';

    if (total <= 1) return;

    // Botón Anterior
    const liPrev = document.createElement('li');
    liPrev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
    liPrev.innerHTML = `<button class="page-link page-link-custom">‹</button>`;
    liPrev.onclick = () => { if (paginaActual > 1) { paginaActual--; paginarTabla(); } };
    paginacion.appendChild(liPrev);

    // Páginas
    let startPage = Math.max(1, paginaActual - 1);
    let endPage = Math.min(total, startPage + 2);
    if (endPage - startPage < 2) startPage = Math.max(1, endPage - 2);

    for (let i = startPage; i <= endPage; i++) {
      const li = document.createElement('li');
      li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
      const btn = document.createElement('button');
      btn.className = 'page-link page-link-custom';
      btn.textContent = i;
      btn.onclick = () => { paginaActual = i; paginarTabla(); };
      li.appendChild(btn);
      paginacion.appendChild(li);
    }

    // Botón Siguiente
    const liNext = document.createElement('li');
    liNext.className = `page-item ${paginaActual === total ? 'disabled' : ''}`;
    liNext.innerHTML = `<button class="page-link page-link-custom">›</button>`;
    liNext.onclick = () => { if (paginaActual < total) { paginaActual++; paginarTabla(); } };
    paginacion.appendChild(liNext);
  }

  document.addEventListener('DOMContentLoaded', paginarTabla);
</script>
{% endblock %}